<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Dashboard</title>
    <link rel="stylesheet" href="{% static 'bootstrap.min.css' %}">
    <style>
    </style>
</head>

<body>
    {% include "navbar.html" %}

    <div class="container mt-5">
        <section class="d-flex flex-wrap justify-content-center justify-content-lg-between">
            <h1 class="text-center text-lg-center">Live Attendance View </h1>
            <!-- <button type="button" class="btn btn-primary btn-lg">Take New Attendance</button> -->
        </section>
        <center class="my-4">
            <h3>Live Student Attendance Records</h3>
        </center>
    </div>

    <div class="container mt-5">
        <center>
            <table id="" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">First Name</th>
                        <th scope="col">Last Name</th>
                        <th scope="col">Student ID</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                    <!-- # {'live_attendance': True, 'attendance_id': 33, 'status': 'lecture', 'course_title': Information Systems, 'course_code': CIT513} -->
                    <tr>
                        <th scope="row">1</th>
                        <td>Mark</td>
                        <td>Test</td>
                        <td>m1623394</td>
                    </tr>
                    {% for index, student in enumerate(attendance) %}
                    <tr>
                        <th scope="row">{{ index + 2}}</th>
                        <td>{{ student.first_name}}</td>
                        <td>{{ student.last_name}}</td>
                        <td>{{ student.student_id}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </center>
    </div>

    {% include "footer.html" %}

    <script>

        const tbody = document.getElementById('attendance-table-body');

        setInterval(fetchLatestRecords, 5000);

        async function fetchLatestRecords() {

            const res = await (await fetch('/retrieve/live/attendance/', {
                method: 'POST',
                credentials: 'include', // Include cookies
            })).json();

            if (res.status === 'success') {
                UpdateAttendanceTable(res.attendance);
                return;
            }

            console.log("[Error]: ", res);
        }


        function UpdateAttendanceTable(attendanceList) {

            const temp = document.createDocumentFragment();
            const row_count = tbody.childElementCount;

            for (let index = 0; index < attendanceList.length; index++) {
                const attendance = attendanceList[index];
                const trow = `
                        <tr>
                            <th scope="row">1${ row_count }</th>
                            <td>Mark</td>
                            <td>Test</td>
                            <td>m1623394</td>
                        </tr>`
                tbody.insertAdjacentHTML("afterbegin")
            }
            tbody.insertAdjacentElement("afterbegin",)
        }
    </script>
</body>

</html>